<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowden - Stealth Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Serial:wght@300&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --terminal-green: #00FF00;
            --bg-black: #000000;
            --border-width: 2px;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
            color: var(--terminal-green);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        /* Main UI Grid Container */
        #ui-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 80px 1fr 120px;
            width: 100vw;
            height: 100vh;
            gap: 0;
        }
        
        /* Top Bar - Full Width */
        #top-bar {
            grid-column: 1 / -1;
            border-bottom: var(--border-width) solid var(--terminal-green);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--bg-black);
        }
        
        #top-bar-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        #top-bar-glitch {
            height: 60px;
            width: auto;
            opacity: 0.9;
        }
        
        #floor-title {
            font-family: 'Apple Garamond Light', serif;
            font-size: 36px;
            font-weight: normal;
            margin-bottom: 5px;
        }
        
        #objective-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            font-weight: 300;
        }
        
        /* Left Panel - Mini Map */
        #left-panel {
            border-right: var(--border-width) solid var(--terminal-green);
            padding: 15px;
            background-color: var(--bg-black);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #controls-info {
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: var(--terminal-green);
            margin-bottom: 15px;
            line-height: 1.6;
            opacity: 0.9;
        }
        
        #controls-info h3 {
            font-size: 12px;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #controls-info p {
            margin: 4px 0;
        }
        
        #controls-info .control-section {
            margin-bottom: 10px;
        }
        
        .indicator-legend {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 3px 0;
        }
        
        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .indicator-red { background-color: #ff0000; }
        .indicator-green { background-color: #00ff00; }
        .indicator-blue { background-color: #0099ff; }
        .indicator-yellow { background-color: #ffff00; }
        
        #mini-map-container {
            width: 100%;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #mini-map-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Center - Game Viewport */
        #game-viewport {
            position: relative;
            background-color: var(--bg-black);
            border-right: var(--border-width) solid var(--terminal-green);
            overflow: hidden;
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* CRT Effect Overlay (only on game viewport) */
        #crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15),
                    rgba(0, 0, 0, 0.15) 1px,
                    transparent 1px,
                    transparent 2px
                );
            box-shadow: inset 0 0 128px 194px rgba(0, 0, 0, 0.95);
            animation: flicker 0.15s infinite;
        }
        
        /* Phosphor glow effect on text */
        #crt-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(0, 255, 0, 0.05) 0%, transparent 70%);
        }
        
        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 1; }
            100% { opacity: 0.97; }
        }
        
        /* Right Panel - Stats */
        #right-panel {
            padding: 20px;
            background-color: var(--bg-black);
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
        }
        
        .stat-item {
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--terminal-green);
        }
        
        #level-description {
            margin-top: 10px;
            line-height: 1.4;
            opacity: 0.9;
        }
        
        /* Bottom Bar - Narrative */
        #bottom-bar {
            grid-column: 1 / -1;
            border-top: var(--border-width) solid var(--terminal-green);
            padding: 15px 20px;
            background-color: var(--bg-black);
            display: flex;
            align-items: center;
        }
        
        #narrative-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: var(--terminal-green);
            min-height: 60px;
        }
        
        /* Typewriter cursor effect */
        .typing::after {
            content: 'â–‹';
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Intro Screen Overlay */
        #intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background-color: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #intro-screen::before {
            content: '';
            position: absolute;
            top: 100px;
            left: 20px;
            width: 100%;
            height: 100%;
            background-image: url('tumblr_nv44lndz1l1u6xnmoo1_1280.gif');
            background-size: 600px auto;
            background-position: center;
            background-repeat: no-repeat;
            mix-blend-mode: hard-light;
            opacity: 0.7;
            z-index: 1;
        }
        
        #intro-screen.hidden {
            display: none;
        }
        
        #intro-snowden-glitch {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 1000px;
            height: auto;
            opacity: 0.9;
            z-index: 2;
        }
        
        #start-prompt {
            font-family: 'Roboto Mono', monospace;
            font-size: 20px;
            color: var(--terminal-green);
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 15px 40px;
            border: 2px solid var(--terminal-green);
            background-color: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            position: absolute;
            bottom: 100px;
            z-index: 3;
        }
        
        #start-prompt:hover {
            background-color: var(--terminal-green);
            color: #000000;
            box-shadow: 0 0 20px var(--terminal-green);
        }
        
        /* Story Intro Screen */
        #story-intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9997;
            background-color: #000000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            padding: 80px;
        }
        
        #story-intro-screen.active {
            display: flex;
            opacity: 1;
        }
        
        #story-intro-screen.fade-out {
            opacity: 0;
        }
        
        #story-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 18px;
            color: var(--terminal-green);
            text-align: center;
            line-height: 1.8;
            max-width: 1200px;
        }
        
        /* Level Intro Screen */
        #level-intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            background-color: #000000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        #level-intro-screen.active {
            display: flex;
            opacity: 1;
        }
        
        #level-intro-screen.fade-out {
            opacity: 0;
        }
        
        /* Level enemy image - centered above text */
        #level-intro-enemy {
            width: 50px;
            height: auto;
            margin-bottom: 40px;
            opacity: 0.9;
        }
        
        #level-intro-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 48px;
            color: var(--terminal-green);
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        
        /* Snowden glitch image in top right */
        #level-intro-glitch {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 200px;
            height: auto;
            opacity: 0.9;
            z-index: 10;
        }
        
        /* Loading bar at bottom */
        #level-intro-loading-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 8px;
            background-color: transparent;
            border: 1px solid var(--terminal-green);
            overflow: hidden;
        }
        
        #level-intro-loading-fill {
            width: 0%;
            height: 100%;
            background-color: var(--terminal-green);
            box-shadow: 0 0 10px var(--terminal-green);
        }
        
        /* Typewriter cursor effect */
        #level-intro-text.typing::after {
            content: 'â–Œ';
            animation: blink-cursor 0.7s step-end infinite;
            margin-left: 2px;
        }
        
        @keyframes blink-cursor {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Level 3 Part 2 Timer Overlay */
        #part2-timer {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            font-family: 'Roboto Mono', monospace;
            font-size: 48px;
            color: var(--terminal-green);
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.7);
            display: none;
            pointer-events: none;
        }
        
        #part2-timer.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="ui-grid">
        <!-- Top Bar -->
        <div id="top-bar">
            <div id="top-bar-content">
                <div id="floor-title">Floor 1 - Lobby and Conference</div>
                <div id="objective-text">Objective: Find the files. Hack the mainframe. Don't get caught.</div>
            </div>
            <img id="top-bar-glitch" src="assets/snowden glitch.png" alt="Snowden">
        </div>
        
        <!-- Left Panel - Mini Map -->
        <div id="left-panel">
            <!-- Controls Info -->
            <div id="controls-info">
                <h3>Controls</h3>
                <div class="control-section">
                    <p><strong>WASD / ARROWS / LEFT STICK</strong> - Move</p>
                    <p><strong>HOLD SPACE / R2</strong> - Sprint</p>
                    <p><strong>ENTER / X</strong> - Interact</p>
                </div>
                
                <h3>Indicators</h3>
                <div class="control-section">
                    <div class="indicator-legend">
                        <div class="indicator-dot indicator-red"></div>
                        <span>Guard</span>
                    </div>
                    <div class="indicator-legend">
                        <div class="indicator-dot indicator-green"></div>
                        <span>Document</span>
                    </div>
                    <div class="indicator-legend">
                        <div class="indicator-dot indicator-blue"></div>
                        <span>Exit</span>
                    </div>
                    <div class="indicator-legend">
                        <div class="indicator-dot indicator-yellow"></div>
                        <span>Sprint Energy</span>
                    </div>
                </div>
            </div>
            
            <!-- Mini Map -->
            <div id="mini-map-container">
                <canvas id="mini-map-canvas"></canvas>
            </div>
        </div>
        
        <!-- Center - Game Viewport -->
        <div id="game-viewport">
            <div id="game-container"></div>
            <div id="crt-overlay"></div>
        </div>
        
        <!-- Right Panel - Stats -->
        <div id="right-panel">
            <div class="stat-item">
                <span class="stat-label">Difficulty:</span> <span id="difficulty">Medium</span>
            </div>
            
            <div id="level-description">
                Infiltrate the lobby and conference areas. Locate classified documents. Avoid detection.
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Building:</span> <span id="building-name">NSA Headquarters</span>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Time:</span> <span id="game-time">3:38:12 AM</span>
            </div>
            
            <div class="stat-item">
                <span class="stat-label" id="guard-label">Guards:</span> <span id="guard-count">12</span>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Documents:</span> <span id="document-count">0/3</span>
            </div>
        </div>
        
        <!-- Bottom Bar - Narrative -->
        <div id="bottom-bar">
            <div id="narrative-text">Find, decode, leak the documents.</div>
        </div>
    </div>
    
    <!-- Intro Screen Overlay -->
    <div id="intro-screen">
        <img id="intro-snowden-glitch" src="assets/snowden glitch.png" alt="Snowden">
        <div id="start-prompt">Press Enter or X to Start</div>
    </div>
    
    <!-- Story Intro Screen -->
    <div id="story-intro-screen">
        <div id="story-text"></div>
    </div>
    
    <!-- Level Intro Screen -->
    <div id="level-intro-screen">
        <img id="level-intro-glitch" src="assets/snowden glitch.png" alt="">
        <img id="level-intro-enemy" src="assets/camera.png" alt="">
        <div id="level-intro-text">Floor 1 - Server Room</div>
        <div id="level-intro-loading-bar">
            <div id="level-intro-loading-fill"></div>
        </div>
    </div>
    
    <!-- Level 3 Part 2 Timer -->
    <div id="part2-timer">TIME: 45s</div>
    
    <!-- Phaser.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
    
    <!-- Intro screen handler (before game loads) -->
    <script>
        // Wait for Enter key to start the game
        let gameStarted = false;
        
        // Function to show level intro screen (can be called from game.js)
        function showLevelIntro(levelName, callback, levelNumber) {
            const levelIntro = document.getElementById('level-intro-screen');
            const levelIntroText = document.getElementById('level-intro-text');
            const loadingFill = document.getElementById('level-intro-loading-fill');
            const enemyImage = document.getElementById('level-intro-enemy');
            
            console.log('ðŸŽ¬ Level intro starting...', levelName, 'Level:', levelNumber);
            
            // Set enemy image based on level
            const enemyImages = {
                1: 'assets/camera.png',
                2: 'assets/coppng.png',
                3: 'assets/droidbot.png'
            };
            
            if (levelNumber && enemyImages[levelNumber]) {
                enemyImage.src = enemyImages[levelNumber];
            }
            
            // Clear text and reset classes
            levelIntroText.textContent = '';
            levelIntro.classList.remove('fade-out', 'level-1', 'level-2', 'level-3');
            levelIntro.style.display = 'flex';
            
            // Add level-specific class for background
            if (levelNumber) {
                levelIntro.classList.add(`level-${levelNumber}`);
            }
            
            // Reset loading bar completely
            loadingFill.classList.remove('filling');
            loadingFill.style.transition = 'none';
            loadingFill.style.width = '0%';
            
            // Add active class to show screen
            levelIntro.classList.add('active');
            
            // Force reflow
            loadingFill.offsetHeight;
            
            // Start loading bar animation after a frame
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    console.log('ðŸŽ¬ Starting loading bar animation');
                    loadingFill.style.transition = 'width 6s linear';
                    loadingFill.style.width = '100%';
                });
            });
            
            // Add typing class for cursor effect
            levelIntroText.classList.add('typing');
            
            // Typewriter effect
            let charIndex = 0;
            const typeSpeed = 80; // milliseconds per character
            
            function typeNextChar() {
                if (charIndex < levelName.length) {
                    levelIntroText.textContent += levelName.charAt(charIndex);
                    charIndex++;
                    setTimeout(typeNextChar, typeSpeed);
                } else {
                    // Typing complete, remove cursor
                    levelIntroText.classList.remove('typing');
                }
            }
            
            // Start typing
            typeNextChar();
            
            // Wait 6 seconds total, then fade out
            setTimeout(() => {
                levelIntro.classList.add('fade-out');
                
                // Wait for fade out animation to complete
                setTimeout(() => {
                    levelIntro.style.display = 'none';
                    levelIntro.classList.remove('active', 'fade-out');
                    
                    // Call callback if provided
                    if (callback) callback();
                }, 1000); // 1 second for fade out
            }, 6000); // 6 seconds total display time
        }
        
        function showStoryIntro(callback) {
            const storyIntro = document.getElementById('story-intro-screen');
            const storyText = document.getElementById('story-text');
            
            const fullText = "In June 2013, Edward Snowden, a 29-year-old contractor for the National Security Agency stationed in Hawaii, leaked over 1.5 million classified files to journalists from The Guardian and The Washington Post. The documents revealed that the NSA was collecting phone records from millions of Verizon customers daily under a secret Foreign Intelligence Surveillance Court order dated April 25, 2013, and that through the PRISM program, tech giants like Google, Apple, and Facebook were compelled to provide direct access to user data. Snowden's disclosures showed that surveillance extended far beyond terrorism suspects, encompassing entire populations and foreign governments alike. The U.S. government immediately charged him under the Espionage Act of 1917, revoked his passport, and sought his extradition. Facing decades in prison, Snowden fled the United States on May 20, 2013, escaping first to Hong Kong and later into exile after releasing evidence that transformed the world's understanding of digital privacy, state power, and the cost of transparency.";
            
            // Split into sentences
            const sentences = fullText.match(/[^\.!\?]+[\.!\?]+/g);
            
            storyText.textContent = '';
            storyIntro.classList.add('active');
            
            let currentSentence = 0;
            let currentChar = 0;
            const typeSpeed = 30; // milliseconds per character
            const sentencePause = 1500; // 1.5 seconds pause after each sentence
            
            function typeCharacter() {
                if (currentSentence < sentences.length) {
                    const sentence = sentences[currentSentence].trim();
                    
                    if (currentChar < sentence.length) {
                        storyText.textContent += sentence.charAt(currentChar);
                        currentChar++;
                        setTimeout(typeCharacter, typeSpeed);
                    } else {
                        // Sentence complete, pause before next
                        currentChar = 0;
                        currentSentence++;
                        if (currentSentence < sentences.length) {
                            storyText.textContent += ' '; // Add space between sentences
                            setTimeout(typeCharacter, sentencePause);
                        } else {
                            // All sentences complete, wait 2 seconds then fade out
                            setTimeout(() => {
                                storyIntro.classList.add('fade-out');
                                setTimeout(() => {
                                    storyIntro.style.display = 'none';
                                    storyIntro.classList.remove('active', 'fade-out');
                                    if (callback) callback();
                                }, 1000); // 1 second fade out
                            }, 2000); // 2 seconds pause at end
                        }
                    }
                }
            }
            
            typeCharacter();
        }
        
        function startGame() {
            if (!gameStarted) {
                gameStarted = true;
                
                // Hide intro screen
                document.getElementById('intro-screen').classList.add('hidden');
                
                // Show story intro first
                showStoryIntro(() => {
                    // Then show level intro screen for Level 1
                    showLevelIntro('Floor 1 - Server Room', () => {
                        // Load the game script after intro
                        const script = document.createElement('script');
                        script.src = 'js/game.js?v=37';
                        document.body.appendChild(script);
                    }, 1);
                });
            }
        }
        
        // PS5 Controller support for intro screen
        let introGamepad = null;
        let lastIntroXButtonState = false;
        
        // Check for connected gamepads
        function checkGamepads() {
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    introGamepad = gamepads[i];
                    break;
                }
            }
        }
        
        // Check if PS5 X button is pressed (button 0)
        function isIntroXButtonPressed() {
            if (!introGamepad || !introGamepad.buttons[0]) return false;
            
            const currentState = introGamepad.buttons[0].pressed;
            const wasPressed = !lastIntroXButtonState && currentState;  // Rising edge detection
            lastIntroXButtonState = currentState;
            
            return wasPressed;
        }
        
        // Listen for Enter key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !gameStarted) {
                startGame();
            }
        });
        
        // Check for controller input on intro screen
        function checkIntroControllerInput() {
            if (!gameStarted) {
                checkGamepads();  // Update gamepad reference
                if (isIntroXButtonPressed()) {
                    startGame();
                }
            }
        }
        
        // Start checking for controller input
        setInterval(checkIntroControllerInput, 16);  // ~60fps polling
        
        // Click button to start
        document.getElementById('start-prompt').addEventListener('click', startGame);
        
        // Function to update right panel info for each level
        function updateRightPanelForLevel(levelNum) {
            const levelInfo = {
                1: {
                    difficulty: 'Easy',
                    description: 'Lobby and conference sectors are under full visual surveillance. Movement must align with timing cycles to remain undetected. Environmental data suggests fixed rotational patterns and narrow dead zones suitable for passage.',
                    building: 'Server Room - NSA Headquarters',
                    time: '3:38:12 AM',
                    guardLabel: 'Cameras:'
                },
                2: {
                    difficulty: 'Medium',
                    description: 'Facility corridors are actively monitored by internal security forces conducting timed patrols. Observation routes overlap near access points, requiring precise movement to avoid interception. Oh, and be very, very, quiet.',
                    building: 'Lobby and Conference - NSA Headquarters',
                    time: '4:15:47 AM',
                    guardLabel: 'Guards:'
                },
                3: {
                    difficulty: 'Hard',
                    description: 'Central operations zone employs adaptive artificial intelligence for threat recognition and predictive tracking. Behavioral patterns are analyzed in real time; consistency increases detection probability. System disruption or evasion must occur before data collection completes.',
                    building: 'Intellectual Property Vault - NSA Headquarters',
                    time: '5:02:33 AM',
                    guardLabel: 'Bots:'
                }
            };
            
            const info = levelInfo[levelNum];
            if (info) {
                document.getElementById('difficulty').textContent = info.difficulty;
                document.getElementById('level-description').textContent = info.description;
                document.getElementById('building-name').textContent = info.building;
                document.getElementById('game-time').textContent = info.time;
                document.getElementById('guard-label').textContent = info.guardLabel;
                // Guard count will be updated by updateGuardCount() from game.js
            }
        }
    </script>
</body>
</html>
