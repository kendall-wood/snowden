<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrol Path Definer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        
        #container {
            display: flex;
            gap: 20px;
        }
        
        #canvas-wrapper {
            position: relative;
            border: 2px solid #00ff00;
            max-width: 1000px;
            max-height: 700px;
            overflow: auto;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
            transform-origin: 0 0;
        }
        
        #controls {
            flex: 1;
            background-color: #000;
            padding: 20px;
            border: 2px solid #00ff00;
            max-width: 400px;
        }
        
        h1 {
            color: #00ff00;
            margin-top: 0;
        }
        
        button {
            background-color: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #005500;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #output {
            background-color: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .path-info {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #00ff00;
        }
        
        .current-path {
            background-color: #003300;
        }
        
        .instructions {
            border: 1px solid #ffff00;
            padding: 10px;
            margin: 10px 0;
            color: #ffff00;
        }
    </style>
</head>
<body>
    <h1>Patrol Path Definer - Snowden Game</h1>
    
    <div id="container">
        <div id="canvas-wrapper">
            <canvas id="canvas"></canvas>
        </div>
        
        <div id="controls">
            <div class="instructions">
                <strong>INSTRUCTIONS:</strong><br>
                1. Select level to edit<br>
                2. Click points along patrol path 1<br>
                3. Click "Next Path" when done<br>
                4. Repeat for all 6 paths<br>
                5. Click "Generate Code" to get coordinates
            </div>
            
            <div style="border: 1px solid #ffff00; padding: 10px; margin: 10px 0; background-color: #222;">
                <strong style="color: #ffff00;">LEVEL SELECT:</strong><br>
                <button id="level1-btn" style="background-color: #003300; border-color: #ffff00; color: #ffff00;">Level 1</button>
                <button id="level2-btn">Level 2</button>
                <button id="level3-btn">Level 3</button>
            </div>
            
            <div id="current-path-info" class="path-info current-path">
                <strong>Current: Path 1</strong><br>
                Points: <span id="point-count">0</span>
            </div>
            
            <div style="border: 1px solid #00ff00; padding: 10px; margin-bottom: 10px;">
                <strong>Zoom:</strong><br>
                <button id="zoom-out-btn">Zoom Out (-)</button>
                <button id="zoom-in-btn">Zoom In (+)</button>
                <button id="fit-btn">Fit to Screen</button>
                <br><span id="zoom-level">25%</span>
            </div>
            
            <button id="undo-btn">Undo Last Point</button>
            <button id="clear-path-btn">Clear Current Path</button>
            <button id="next-path-btn">Next Path (1 → 2)</button>
            <br><br>
            <button id="generate-btn" disabled>Generate Code</button>
            <button id="reset-btn">Reset All</button>
            
            <div id="output"></div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        // Level configuration
        let currentLevel = 1;
        const levelMaps = {
            1: 'assets/lvl-1-map.png',  // Level 1 uses main map
            2: 'assets/lvl-2-map.png',  // Level 2 map
            3: 'assets/lvl-3-map.png'   // Level 3 map
        };
        
        // Store all patrol paths
        let allPaths = [[], [], [], [], [], []];
        let currentPathIndex = 0;
        let zoomLevel = 0.25;  // Start at 25% zoom
        
        // Load the map for current level
        img.src = levelMaps[currentLevel];
        
        img.onerror = function() {
            alert('Error loading image! Make sure you open this file via the local server at http://127.0.0.1:8000/patrol-path-tool.html');
            console.error('Failed to load: assets/LVL1-coppaths.png');
        };
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            applyZoom();
            redraw();
        };
        
        // Apply zoom transform
        function applyZoom() {
            canvas.style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
        }
        
        // Click handler
        canvas.addEventListener('click', function(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.round((e.clientX - rect.left) * scaleX);
            const y = Math.round((e.clientY - rect.top) * scaleY);
            
            console.log(`Clicked at: (${x}, ${y})`);
            
            // Add point to current path
            allPaths[currentPathIndex].push({x, y});
            console.log(`Path ${currentPathIndex + 1} now has ${allPaths[currentPathIndex].length} points`);
            updateUI();
            redraw();
        });
        
        // Redraw canvas
        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // Draw all paths
            const colors = ['#00ff00', '#00ffff', '#ff00ff', '#ffff00', '#ff8800', '#ffffff'];
            
            allPaths.forEach((path, pathIndex) => {
                if (path.length === 0) return;
                
                const color = colors[pathIndex];
                
                // Scale sizes based on zoom for visibility
                const lineWidth = 15 / zoomLevel;
                const dotSize = 40 / zoomLevel;
                const fontSize = 30 / zoomLevel;
                
                // Draw lines between points
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                ctx.moveTo(path[0].x, path[0].y);
                for (let i = 1; i < path.length; i++) {
                    ctx.lineTo(path[i].x, path[i].y);
                }
                ctx.stroke();
                
                // Draw points
                path.forEach((point, index) => {
                    // Draw white outline
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, dotSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw colored center
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, dotSize * 0.85, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw point number
                    ctx.fillStyle = '#000';
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(index + 1, point.x, point.y);
                });
            });
        }
        
        // Update UI
        function updateUI() {
            const pointCountEl = document.getElementById('point-count');
            const pathInfoEl = document.getElementById('current-path-info');
            const nextBtn = document.getElementById('next-path-btn');
            const genBtn = document.getElementById('generate-btn');
            
            if (pointCountEl) {
                pointCountEl.textContent = allPaths[currentPathIndex].length;
            }
            
            if (pathInfoEl) {
                pathInfoEl.innerHTML = 
                    `<strong>Current: Path ${currentPathIndex + 1}</strong><br>Points: ${allPaths[currentPathIndex].length}`;
            }
            
            if (nextBtn) {
                if (currentPathIndex < 5) {
                    nextBtn.textContent = `Next Path (${currentPathIndex + 1} → ${currentPathIndex + 2})`;
                    nextBtn.disabled = false;
                } else {
                    nextBtn.textContent = 'All Paths Complete!';
                    nextBtn.disabled = true;
                    if (genBtn) genBtn.disabled = false;
                }
            }
        }
        
        // Zoom controls
        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            zoomLevel = Math.max(0.1, zoomLevel - 0.1);
            applyZoom();
            redraw();
        });
        
        document.getElementById('zoom-in-btn').addEventListener('click', () => {
            zoomLevel = Math.min(2, zoomLevel + 0.1);
            applyZoom();
            redraw();
        });
        
        document.getElementById('fit-btn').addEventListener('click', () => {
            zoomLevel = 0.25;
            applyZoom();
            redraw();
        });
        
        // Undo last point
        document.getElementById('undo-btn').addEventListener('click', () => {
            allPaths[currentPathIndex].pop();
            updateUI();
            redraw();
        });
        
        // Clear current path
        document.getElementById('clear-path-btn').addEventListener('click', () => {
            allPaths[currentPathIndex] = [];
            updateUI();
            redraw();
        });
        
        // Next path
        document.getElementById('next-path-btn').addEventListener('click', () => {
            if (currentPathIndex < 5) {
                currentPathIndex++;
                updateUI();
                redraw();
            }
        });
        
        // Reset all
        document.getElementById('reset-btn').addEventListener('click', () => {
            if (confirm('Reset all paths?')) {
                allPaths = [[], [], [], [], [], []];
                currentPathIndex = 0;
                updateUI();
                redraw();
                document.getElementById('output').innerHTML = '';
                document.getElementById('generate-btn').disabled = true;
            }
        });
        
        // Generate code
        document.getElementById('generate-btn').addEventListener('click', () => {
            const output = document.getElementById('output');
            
            let code = `// Patrol paths for Level ${currentLevel}\n`;
            code += 'const PATROL_PATHS = [\n';
            
            allPaths.forEach((path, index) => {
                code += `    // Path ${index + 1} (${path.length} waypoints)\n`;
                code += '    [\n';
                path.forEach((point, pIndex) => {
                    code += `        {x: ${point.x}, y: ${point.y}}`;
                    if (pIndex < path.length - 1) code += ',';
                    code += '\n';
                });
                code += '    ]';
                if (index < allPaths.length - 1) code += ',';
                code += '\n';
            });
            
            code += '];\n\n';
            code += '// Summary:\n';
            allPaths.forEach((path, index) => {
                code += `// Path ${index + 1}: ${path.length} waypoints\n`;
            });
            
            output.innerHTML = `<pre>${code}</pre>`;
            
            // Also log to console
            console.log(code);
            alert('Code generated! Check the output box and browser console. Copy and paste into your game code.');
        });
        
        // Level switching
        document.getElementById('level1-btn').addEventListener('click', () => {
            if (currentLevel === 1) return;
            
            // Confirm if user has unsaved changes
            if (allPaths.some(path => path.length > 0)) {
                if (!confirm(`Switch to Level 1? Any unsaved paths for Level ${currentLevel} will be lost.`)) {
                    return;
                }
            }
            
            currentLevel = 1;
            img.src = levelMaps[currentLevel];
            allPaths = [[], [], [], [], [], []];
            currentPathIndex = 0;
            updateUI();
            
            // Update button styles
            document.getElementById('level1-btn').style.backgroundColor = '#003300';
            document.getElementById('level1-btn').style.borderColor = '#ffff00';
            document.getElementById('level1-btn').style.color = '#ffff00';
            document.getElementById('level2-btn').style.backgroundColor = 'transparent';
            document.getElementById('level2-btn').style.borderColor = '#00ff00';
            document.getElementById('level2-btn').style.color = '#00ff00';
            document.getElementById('level3-btn').style.backgroundColor = 'transparent';
            document.getElementById('level3-btn').style.borderColor = '#00ff00';
            document.getElementById('level3-btn').style.color = '#00ff00';
            document.getElementById('output').innerHTML = '';
        });
        
        document.getElementById('level2-btn').addEventListener('click', () => {
            if (currentLevel === 2) return;
            
            // Confirm if user has unsaved changes
            if (allPaths.some(path => path.length > 0)) {
                if (!confirm(`Switch to Level 2? Any unsaved paths for Level ${currentLevel} will be lost.`)) {
                    return;
                }
            }
            
            currentLevel = 2;
            img.src = levelMaps[currentLevel];
            allPaths = [[], [], [], [], [], []];
            currentPathIndex = 0;
            updateUI();
            
            // Update button styles
            document.getElementById('level1-btn').style.backgroundColor = 'transparent';
            document.getElementById('level1-btn').style.borderColor = '#00ff00';
            document.getElementById('level1-btn').style.color = '#00ff00';
            document.getElementById('level2-btn').style.backgroundColor = '#003300';
            document.getElementById('level2-btn').style.borderColor = '#ffff00';
            document.getElementById('level2-btn').style.color = '#ffff00';
            document.getElementById('level3-btn').style.backgroundColor = 'transparent';
            document.getElementById('level3-btn').style.borderColor = '#00ff00';
            document.getElementById('level3-btn').style.color = '#00ff00';
            document.getElementById('output').innerHTML = '';
        });
        
        document.getElementById('level3-btn').addEventListener('click', () => {
            if (currentLevel === 3) return;
            
            // Confirm if user has unsaved changes
            if (allPaths.some(path => path.length > 0)) {
                if (!confirm(`Switch to Level 3? Any unsaved paths for Level ${currentLevel} will be lost.`)) {
                    return;
                }
            }
            
            currentLevel = 3;
            img.src = levelMaps[currentLevel];
            allPaths = [[], [], [], [], [], []];
            currentPathIndex = 0;
            updateUI();
            
            // Update button styles
            document.getElementById('level1-btn').style.backgroundColor = 'transparent';
            document.getElementById('level1-btn').style.borderColor = '#00ff00';
            document.getElementById('level1-btn').style.color = '#00ff00';
            document.getElementById('level2-btn').style.backgroundColor = 'transparent';
            document.getElementById('level2-btn').style.borderColor = '#00ff00';
            document.getElementById('level2-btn').style.color = '#00ff00';
            document.getElementById('level3-btn').style.backgroundColor = '#003300';
            document.getElementById('level3-btn').style.borderColor = '#ffff00';
            document.getElementById('level3-btn').style.color = '#ffff00';
            document.getElementById('output').innerHTML = '';
        });
        
        // Initialize
        updateUI();
    </script>
</body>
</html>
